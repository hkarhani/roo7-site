<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Active Job Details</title>
  <script type="module" src="frontend-config.js?v=2.5"></script>
  <script src="theme-manager.js?v=1.1"></script>
  <link rel="stylesheet" href="dashboard.css?v=2.4" />
  <link rel="stylesheet" href="admin-dashboard.css?v=2.4" />
  <link rel="stylesheet" href="admin-jobs-manager.css?v=3.0" />
  <style>
    /* Job Details Specific Styles */
    .page-container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }

    .breadcrumb {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 8px;
      padding: 12px 20px;
      margin-bottom: 20px;
      font-size: 0.9rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .breadcrumb a {
      color: #007bff;
      text-decoration: none;
    }

    .breadcrumb a:hover {
      text-decoration: underline;
    }

    .breadcrumb span {
      color: #6c757d;
    }

    .job-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
    }

    .job-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      z-index: 1;
    }

    .job-header-content {
      position: relative;
      z-index: 2;
    }

    .job-title {
      font-size: 2rem;
      font-weight: 700;
      margin: 0 0 10px 0;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .status-badges {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .job-status-badge {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: white;
    }

    .status-healthy { background: #28a745; }
    .status-attention { background: #ffc107; color: #212529; }
    .status-running { background: #007bff; }
    .status-failed { background: #dc3545; }

    .job-header-details {
      margin-top: 15px;
    }

    .text-danger {
      color: #dc3545 !important;
      font-weight: 600;
    }

    .text-warning {
      color: #ffc107 !important;
      font-weight: 600;
    }

    .job-subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
      margin: 0;
    }

    .job-actions {
      margin-top: 20px;
      display: flex;
      gap: 15px;
    }

    /* Override job-actions button styles for specific button classes */
    .job-actions .primary-button {
      padding: 10px 20px;
      border: none;
      background: #0077cc;
      color: white;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
    }

    .job-actions .primary-button:hover {
      background: #005fa3;
      transform: translateY(-1px);
    }

    .job-actions .secondary-button {
      padding: 10px 20px;
      border: 2px solid rgba(255, 255, 255, 0.6);
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
    }

    .job-actions .secondary-button:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.8);
    }

    /* Fallback for buttons without specific classes */
    .job-actions button:not(.primary-button):not(.secondary-button) {
      padding: 10px 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
    }

    .job-actions button:not(.primary-button):not(.secondary-button):hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .config-section {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
    }

    .config-group {
      background: rgba(0, 0, 0, 0.02);
      border-radius: 10px;
      padding: 20px;
    }

    .config-group h3 {
      margin: 0 0 15px 0;
      color: #2c3e50;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .config-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .config-item:last-child {
      border-bottom: none;
    }

    .config-label {
      font-weight: 500;
      color: #495057;
    }

    .config-value {
      font-weight: 600;
      color: #2c3e50;
    }

    .portfolio-section {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .portfolio-tabs {
      display: flex;
      border-bottom: 2px solid #e9ecef;
      margin-bottom: 20px;
      gap: 5px;
    }

    .portfolio-tab {
      padding: 12px 24px;
      border: none;
      background: none;
      color: #6c757d;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }

    .portfolio-tab.active {
      color: #007bff;
      border-bottom-color: #007bff;
    }

    .portfolio-content {
      display: none;
    }

    .portfolio-content.active {
      display: block;
    }

    .portfolio-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
    }

    .portfolio-item {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
      border-left: 4px solid #007bff;
    }

    .portfolio-symbol {
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 4px;
    }

    .portfolio-weight {
      color: #6c757d;
      font-size: 0.9rem;
    }

    .execution-section {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      height: 600px;
      display: flex;
      flex-direction: column;
    }

    .execution-header {
      padding: 20px 25px;
      border-bottom: 2px solid #e9ecef;
      background: #f8f9fa;
    }

    .execution-header h2 {
      margin: 0;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .execution-body {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .execution-list {
      width: 350px;
      border-right: 2px solid #e9ecef;
      background: #f8f9fa;
      overflow-y: auto;
    }

    .execution-details {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .execution-item {
      padding: 15px 20px;
      border-bottom: 1px solid #dee2e6;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .execution-item:hover {
      background: rgba(0, 123, 255, 0.1);
    }

    .execution-item.selected {
      background: #007bff;
      color: white;
    }

    .execution-item.selected::after {
      content: '';
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      border-left: 10px solid #007bff;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
    }

    .execution-status {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .execution-meta {
      font-size: 0.85rem;
      opacity: 0.8;
    }

    .execution-duration {
      font-weight: 600;
    }

    .log-timeline {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
    }

    .timeline-item {
      display: flex;
      margin-bottom: 20px;
      position: relative;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: 15px;
      top: 35px;
      bottom: -10px;
      width: 2px;
      background: #dee2e6;
    }

    .timeline-item:last-child::before {
      display: none;
    }

    .timeline-marker {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #6c757d;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 600;
      margin-right: 15px;
      flex-shrink: 0;
      z-index: 1;
      position: relative;
    }

    .timeline-marker.success { background: #28a745; }
    .timeline-marker.error { background: #dc3545; }
    .timeline-marker.warning { background: #ffc107; color: #212529; }
    .timeline-marker.info { background: #17a2b8; }

    .timeline-content {
      flex: 1;
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .timeline-title {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 5px;
    }

    .timeline-time {
      color: #6c757d;
      font-size: 0.85rem;
      margin-bottom: 10px;
    }

    .timeline-message {
      color: #495057;
      line-height: 1.4;
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-label {
      color: #6c757d;
      font-size: 0.9rem;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6c757d;
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .report-action-btn {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 0.75rem;
      cursor: pointer;
      color: #495057;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-block;
      white-space: nowrap;
    }

    .report-action-btn:hover {
      background: #e9ecef;
      border-color: #adb5bd;
      color: #212529;
    }

    .report-action-btn:active {
      background: #dee2e6;
      transform: scale(0.98);
    }

    .report-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      overflow-y: auto;
    }

    .report-modal-content {
      background: white;
      margin: 2% auto;
      padding: 20px;
      width: 90%;
      max-width: 1200px;
      border-radius: 8px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .report-modal-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #dee2e6;
    }

    .report-modal-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #2c3e50;
      margin: 0;
    }

    .report-modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #6c757d;
      padding: 5px;
      margin-left: auto;
    }

    .report-modal-close:hover {
      color: #dc3545;
    }

    .report-json-viewer {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 0.85rem;
      white-space: pre-wrap;
      max-height: 60vh;
      overflow-y: auto;
    }

    .loading-spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .execution-body {
        flex-direction: column;
      }
      
      .execution-list {
        width: 100%;
        height: 250px;
      }
      
      .config-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-header">
    <h1 id="page-title">üìã Job Details</h1>
    <div class="actions">
      <button id="back-to-jobs">‚Üê Jobs Manager</button>
      <button id="back-to-admin">‚Üê Admin Dashboard</button>
      <div class="refresh-indicator">
        <span id="last-refresh">Never</span>
        <button id="refresh-job" class="secondary-button">üîÑ Refresh</button>
      </div>
      <button id="toggle-theme">Toggle Theme</button>
      <button id="logout-btn">Logout</button>
    </div>
  </div>

  <main class="dashboard-container">
    <!-- Job Header Info -->
    <section class="dashboard-card" id="job-header">
      <div class="section-header">
        <h2 id="job-account-name">Loading...</h2>
        <div class="status-badges">
          <span class="job-status-badge" id="job-status-badge">
            <div class="loading-spinner"></div>
          </span>
        </div>
      </div>
      <div class="job-header-details">
        <p id="job-subtitle">Account ID: <span id="job-account-id">-</span></p>
        <div class="job-actions" id="job-actions" style="margin-top: 15px;">
          <button id="force-run-btn" class="primary-button">‚ñ∂Ô∏è Force Run</button>
          <button id="pause-job-btn" class="secondary-button">‚è∏Ô∏è Pause Job</button>
          <button id="view-logs-btn" class="secondary-button">üìÑ View All Logs</button>
        </div>
      </div>
    </section>

    <!-- Statistics Row -->
    <section class="dashboard-card" id="job-stats">
      <div class="section-header">
        <h2>üìä Job Statistics</h2>
      </div>
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-number" id="success-rate">-%</div>
          <div class="stat-label">Success Rate</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="total-executions">-</div>
          <div class="stat-label">Total Executions</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="avg-duration">-</div>
          <div class="stat-label">Avg Duration</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="consecutive-failures">-</div>
          <div class="stat-label">Consecutive Failures</div>
        </div>
      </div>
    </section>

    <!-- Job Configuration -->
    <section class="dashboard-card" id="job-config">
      <div class="section-header">
        <h2>üîß Job Configuration</h2>
      </div>
      <div class="config-grid">
        <div class="config-group">
          <h3>‚öôÔ∏è Basic Settings</h3>
          <div id="basic-config">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
        <div class="config-group">
          <h3>üìä Portfolio Settings</h3>
          <div id="portfolio-config">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
        <div class="config-group">
          <h3>‚è∞ Scheduling</h3>
          <div id="scheduling-config">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
        <div class="config-group">
          <h3>üîÑ Execution Settings</h3>
          <div id="execution-config">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </section>

    <!-- Portfolio Details -->
    <section class="dashboard-card" id="portfolio-section">
      <div class="section-header">
        <h2>üìà Portfolio Configuration</h2>
      </div>
      <div class="portfolio-tabs">
        <button class="portfolio-tab active" data-tab="target">Target Portfolio</button>
        <button class="portfolio-tab" data-tab="source">Source Portfolio</button>
      </div>
      
      <div class="portfolio-content active" id="target-portfolio">
        <div class="portfolio-grid" id="target-portfolio-grid">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>
      
      <div class="portfolio-content" id="source-portfolio">
        <div class="portfolio-grid" id="source-portfolio-grid">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>
    </section>

    <!-- Execution History with Split View -->
    <section class="dashboard-card execution-section">
      <div class="section-header">
        <h2>üìã Execution History & Logs</h2>
        <div class="logs-actions">
          <button id="download-logs-btn" class="secondary-button" style="display: none;">üíæ Download Logs</button>
          <button id="view-full-logs-btn" class="secondary-button" style="display: none;">üìÑ View Full Logs</button>
        </div>
      </div>
      <div class="execution-body">
        <!-- Left Side: Execution List -->
        <div class="execution-list">
          <div id="execution-loading" style="padding: 40px; text-align: center;">
            <div class="loading-spinner"></div>
            <p style="margin-top: 15px; color: #6c757d;">Loading executions...</p>
          </div>
          <div id="execution-items">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
        
        <!-- Right Side: Execution Details -->
        <div class="execution-details">
          <div id="execution-details-empty" class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <h3>Select an Execution</h3>
            <p>Choose an execution from the list to view detailed logs and timeline.</p>
          </div>
          <div id="execution-details-content" style="display: none;">
            <!-- Will be populated when an execution is selected -->
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    let currentAccountId = null;
    let jobDetails = null;
    let executionHistory = [];
    let selectedExecution = null;

    // Configuration - Direct port 8004 access to jobs-manager service
    const API_BASE = 'https://api.roo7.site:8004/admin/jobs-manager';
    
    // Simple caching to reduce API calls
    const CACHE_DURATION = 30000; // 30 seconds
    let jobDetailsCache = null;
    let jobDetailsCacheTime = 0;

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      currentAccountId = getAccountIdFromUrl();
      if (!currentAccountId) {
        showError('No account ID provided');
        return;
      }

      setupEventListeners();
      loadJobDetails();
    });

    function getAccountIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('account_id');
    }

    function setupEventListeners() {
      // Navigation
      document.getElementById('back-to-jobs').addEventListener('click', () => {
        window.location.href = 'admin-jobs-manager.html';
      });
      document.getElementById('back-to-admin').addEventListener('click', () => {
        window.location.href = 'admin-dashboard.html';
      });

      // Refresh controls
      document.getElementById('refresh-job').addEventListener('click', () => loadJobDetails(true));

      // Portfolio tabs
      document.querySelectorAll('.portfolio-tab').forEach(tab => {
        tab.addEventListener('click', () => switchPortfolioTab(tab.dataset.tab));
      });

      // Job actions
      document.getElementById('force-run-btn').addEventListener('click', () => forceJobExecution());
      document.getElementById('pause-job-btn').addEventListener('click', () => pauseJob());
      document.getElementById('view-logs-btn').addEventListener('click', () => viewAllLogs());

      // New log viewing actions
      document.getElementById('download-logs-btn').addEventListener('click', () => downloadCurrentLogs());
      document.getElementById('view-full-logs-btn').addEventListener('click', () => viewFullLogs());

      // Theme and logout
      document.getElementById('toggle-theme').addEventListener('click', toggleTheme);
      document.getElementById('logout-btn').addEventListener('click', logout);
    }

    async function loadJobDetails(forceRefresh = false) {
      try {
        // Check cache first if not forced refresh
        const now = Date.now();
        if (!forceRefresh && jobDetailsCache && (now - jobDetailsCacheTime) < CACHE_DURATION) {
          console.log('Using cached job details');
          const data = jobDetailsCache;
          jobDetails = data.active_job;
          executionHistory = data.execution_history || [];
          renderJobHeader(jobDetails);
          renderJobStats(data.statistics || {});
          renderJobConfiguration(jobDetails);
          renderPortfolioDetails(jobDetails);
          renderExecutionHistory(executionHistory);
          return;
        }

        const token = getAuthToken();
        if (!token) {
          throw new Error('No authentication token found. Please login again.');
        }
        
        console.log('Fetching fresh job details from API:', `${API_BASE}/frontend/job-details/${encodeURIComponent(currentAccountId)}`);
        console.log('Using token:', token ? '***' + token.slice(-8) : 'None');
        
        const response = await fetch(`${API_BASE}/frontend/job-details/${encodeURIComponent(currentAccountId)}`, {
          method: 'GET',
          mode: 'cors',
          credentials: 'include',
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        
        // Update cache
        jobDetailsCache = data;
        jobDetailsCacheTime = now;
        
        jobDetails = data.active_job;
        executionHistory = data.execution_history || [];

        renderJobHeader(jobDetails);
        renderJobStats(data.statistics || {});
        renderJobConfiguration(jobDetails);
        renderPortfolioDetails(jobDetails);
        renderExecutionHistory(executionHistory);
        updateLastRefreshTime();

      } catch (error) {
        console.error('Error loading job details:', error);
        showError('Failed to load job details: ' + error.message);
      }
    }

    function renderJobHeader(job) {
      // Update page title
      document.getElementById('page-title').textContent = `üìã ${job.account_name} - Job Details`;
      document.getElementById('job-account-name').textContent = job.account_name;
      document.getElementById('job-account-id').textContent = job.account_id;
      
      const statusBadge = document.getElementById('job-status-badge');
      const isRunning = job.run_status === 'RUNNING';
      const needsAttention = job.consecutive_failures > 0 || ['FAILED', 'BACKOFF', 'STALLED'].includes(job.run_status);
      const isHealthy = job.consecutive_failures === 0 && !['FAILED', 'STALLED'].includes(job.run_status);

      let statusClass = 'status-failed';
      let statusText = '‚ùå Failed';
      
      if (isRunning) {
        statusClass = 'status-running';
        statusText = 'üîÑ Running';
      } else if (needsAttention) {
        statusClass = 'status-attention';
        statusText = '‚ö†Ô∏è Needs Attention';
      } else if (isHealthy) {
        statusClass = 'status-healthy';
        statusText = '‚úÖ Healthy';
      }

      statusBadge.className = `job-status-badge ${statusClass}`;
      statusBadge.innerHTML = statusText;

      // Update action buttons
      const forceRunBtn = document.getElementById('force-run-btn');
      const pauseBtn = document.getElementById('pause-job-btn');
      
      if (isRunning) {
        forceRunBtn.disabled = true;
        forceRunBtn.innerHTML = 'üîÑ Running...';
      } else {
        forceRunBtn.disabled = false;
        forceRunBtn.innerHTML = '‚ñ∂Ô∏è Force Run';
      }

      if (job.status === 'PAUSED') {
        pauseBtn.innerHTML = '‚ñ∂Ô∏è Resume Job';
      } else {
        pauseBtn.innerHTML = '‚è∏Ô∏è Pause Job';
      }
    }

    function renderJobStats(stats) {
      document.getElementById('success-rate').textContent = `${stats.success_rate_percent || 0}%`;
      document.getElementById('total-executions').textContent = stats.total_executions || 0;
      document.getElementById('avg-duration').textContent = stats.average_duration_formatted || 'N/A';
      document.getElementById('consecutive-failures').textContent = jobDetails.consecutive_failures || 0;
    }

    function renderJobConfiguration(job) {
      // Basic settings
      document.getElementById('basic-config').innerHTML = `
        <div class="config-item">
          <span class="config-label">Job Type</span>
          <span class="config-value">${job.job_type}</span>
        </div>
        <div class="config-item">
          <span class="config-label">Strategy</span>
          <span class="config-value">${job.strategy}</span>
        </div>
        <div class="config-item">
          <span class="config-label">Status</span>
          <span class="config-value">${job.status}</span>
        </div>
        <div class="config-item">
          <span class="config-label">Run Status</span>
          <span class="config-value">${job.run_status}</span>
        </div>
      `;

      // Portfolio settings
      document.getElementById('portfolio-config').innerHTML = `
        <div class="config-item">
          <span class="config-label">Hedge Percent</span>
          <span class="config-value">${job.hedge_percent}%</span>
        </div>
        <div class="config-item">
          <span class="config-label">Top Instruments</span>
          <span class="config-value">${job.top_x_instruments}</span>
        </div>
        <div class="config-item">
          <span class="config-label">Portfolio Source</span>
          <span class="config-value">${job.portfolio_source}</span>
        </div>
        <div class="config-item">
          <span class="config-label">Last Updated</span>
          <span class="config-value">${job.portfolio_last_updated ? formatDateTime(job.portfolio_last_updated) : 'Never'}</span>
        </div>
      `;

      // Calculate scheduling health
      const now = new Date();
      const lastRun = job.last_run_at ? new Date(job.last_run_at) : null;
      const nextRun = job.next_run_at ? new Date(job.next_run_at) : null;
      const cadenceMs = job.cadence_minutes * 60 * 1000;
      
      let schedulingStatus = 'healthy';
      let schedulingMessage = '';
      
      if (lastRun) {
        const timeSinceLastRun = now - lastRun;
        const expectedNextRun = new Date(lastRun.getTime() + cadenceMs);
        
        if (timeSinceLastRun > cadenceMs * 3) { // More than 3 cadence periods
          schedulingStatus = 'critical';
          schedulingMessage = `‚ö†Ô∏è Job hasn't run for ${Math.floor(timeSinceLastRun / (1000 * 60 * 60 * 24))} days (expected every ${job.cadence_minutes} min)`;
        } else if (timeSinceLastRun > cadenceMs * 1.5) { // More than 1.5x the cadence
          schedulingStatus = 'warning';
          schedulingMessage = `‚ö†Ô∏è Job is ${Math.floor((timeSinceLastRun - cadenceMs) / (1000 * 60))} minutes overdue`;
        }
      }

      // Scheduling
      document.getElementById('scheduling-config').innerHTML = `
        ${schedulingStatus !== 'healthy' ? `
          <div class="config-item" style="grid-column: 1 / -1; background: #fff3cd; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
            <span style="color: #856404; font-weight: 600;">${schedulingMessage}</span>
          </div>
        ` : ''}
        <div class="config-item">
          <span class="config-label">Cadence</span>
          <span class="config-value">${job.cadence_minutes} minutes</span>
        </div>
        <div class="config-item">
          <span class="config-label">Next Run</span>
          <span class="config-value ${schedulingStatus === 'critical' ? 'text-danger' : ''}">${job.next_run_at ? formatDateTime(job.next_run_at) : 'Not scheduled'}</span>
        </div>
        <div class="config-item">
          <span class="config-label">Last Run</span>
          <span class="config-value ${schedulingStatus === 'critical' ? 'text-danger' : ''}">${job.last_run_at ? formatDateTime(job.last_run_at) : 'Never'}</span>
        </div>
        <div class="config-item">
          <span class="config-label">Created</span>
          <span class="config-value">${formatDateTime(job.created_at)}</span>
        </div>
      `;

      // Execution settings
      document.getElementById('execution-config').innerHTML = `
        <div class="config-item">
          <span class="config-label">Max Failures</span>
          <span class="config-value">${job.max_failures}</span>
        </div>
        <div class="config-item">
          <span class="config-label">Consecutive Failures</span>
          <span class="config-value">${job.consecutive_failures}</span>
        </div>
        <div class="config-item">
          <span class="config-label">Current Job ID</span>
          <span class="config-value">${job.current_job_id || 'None'}</span>
        </div>
        <div class="config-item">
          <span class="config-label">Last Job ID</span>
          <span class="config-value">${job.last_job_id || 'None'}</span>
        </div>
      `;
    }

    function renderPortfolioDetails(job) {
      // Debug: Log the job object to see what portfolio data is available
      console.log('Job data for portfolio rendering:', {
        target_portfolio: job.target_portfolio,
        source_portfolio: job.source_portfolio,
        portfolio: job.portfolio,
        target_weights: job.target_weights,
        current_weights: job.current_weights,
        all_keys: Object.keys(job)
      });

      // Target portfolio - try multiple possible field names
      const targetGrid = document.getElementById('target-portfolio-grid');
      const targetPortfolio = job.target_portfolio || job.target_weights || job.portfolio?.target;
      
      if (targetPortfolio && typeof targetPortfolio === 'object' && Object.keys(targetPortfolio).length > 0) {
        targetGrid.innerHTML = Object.entries(targetPortfolio)
          .map(([symbol, weight]) => {
            // Handle different weight formats
            const weightValue = typeof weight === 'object' ? 
              (weight.weight || weight.target_weight || weight.value || 0) : weight;
            return `
              <div class="portfolio-item">
                <div class="portfolio-symbol">${symbol}</div>
                <div class="portfolio-weight">${(weightValue * 100).toFixed(2)}%</div>
              </div>
            `;
          }).join('');
      } else {
        targetGrid.innerHTML = '<div class="empty-state"><p>No target portfolio configured</p></div>';
      }

      // Source portfolio - try multiple possible field names
      const sourceGrid = document.getElementById('source-portfolio-grid');
      const sourcePortfolio = job.source_portfolio || job.current_weights || job.portfolio?.current || job.portfolio?.source;
      
      if (sourcePortfolio && typeof sourcePortfolio === 'object' && Object.keys(sourcePortfolio).length > 0) {
        // Check if this looks like portfolio snapshot data vs. weights
        const isPortfolioSnapshot = Object.keys(sourcePortfolio).some(key => 
          ['total_value_usdt', 'spot_assets', 'usdtm_assets', 'coinm_assets', 'snapshot_timestamp'].includes(key)
        );
        
        if (isPortfolioSnapshot) {
          // Handle portfolio snapshot data - filter and format appropriately
          sourceGrid.innerHTML = Object.entries(sourcePortfolio)
            .filter(([key, value]) => {
              // Only show meaningful fields, skip metadata and zero values
              if (['snapshot_timestamp', 'source_sync_timestamp', 'source_account_name', 'source_last_portfolio_update'].includes(key)) return false;
              if (typeof value === 'number' && value === 0) return false;
              return true;
            })
            .map(([key, value]) => {
              let displayValue;
              if (typeof value === 'number') {
                if (key.includes('value') || key.includes('pnl')) {
                  displayValue = `$${value.toFixed(2)}`;
                } else if (key.includes('mode') && (value === 0 || value === 1)) {
                  displayValue = value === 1 ? 'Enabled' : 'Disabled';
                } else {
                  displayValue = value.toFixed(2);
                }
              } else if (Array.isArray(value)) {
                if (value.length === 0) {
                  displayValue = 'None';
                } else if (value.length <= 3) {
                  displayValue = value.map(item => typeof item === 'object' ? JSON.stringify(item) : item).join(', ');
                } else {
                  displayValue = `${value.length} items`;
                }
              } else if (typeof value === 'object' && value !== null) {
                displayValue = JSON.stringify(value);
              } else if (typeof value === 'boolean') {
                displayValue = value ? 'Yes' : 'No';
              } else {
                displayValue = String(value) || 'N/A';
              }
              
              return `
                <div class="portfolio-item">
                  <div class="portfolio-symbol">${key.replace(/_/g, ' ').toUpperCase()}</div>
                  <div class="portfolio-weight">${displayValue}</div>
                </div>
              `;
            }).join('');
        } else {
          // Handle weight data as before
          sourceGrid.innerHTML = Object.entries(sourcePortfolio)
            .map(([symbol, data]) => {
              // Handle different weight formats
              const weight = typeof data === 'object' ? 
                (data.weight || data.current_weight || data.value || 0) : data;
              return `
                <div class="portfolio-item">
                  <div class="portfolio-symbol">${symbol}</div>
                  <div class="portfolio-weight">${(weight * 100).toFixed(2)}%</div>
                </div>
              `;
            }).join('');
        }
      } else {
        sourceGrid.innerHTML = '<div class="empty-state"><p>No source portfolio available</p></div>';
      }
    }

    function renderExecutionHistory(executions) {
      document.getElementById('execution-loading').style.display = 'none';
      
      const container = document.getElementById('execution-items');
      if (!executions || executions.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No execution history available</p></div>';
        return;
      }

      // Calculate time gaps between executions for diagnostic purposes
      const executionsWithGaps = executions.map((execution, index) => {
        const current = new Date(execution.started_at);
        const next = index > 0 ? new Date(executions[index - 1].started_at) : new Date();
        const gapHours = Math.floor((next - current) / (1000 * 60 * 60));
        return { ...execution, gapHours };
      });

      container.innerHTML = executionsWithGaps.map((execution, index) => {
        const gapWarning = execution.gapHours > (jobDetails?.cadence_minutes / 60 * 2) ? 
          `<div style="color: #dc3545; font-size: 0.75rem; margin-top: 2px;">‚è∞ ${execution.gapHours}h gap to next</div>` : '';
        
        return `
          <div class="execution-item" data-execution-id="${execution._id}" onclick="selectExecution('${execution._id}')">
            <div class="execution-status">
              <span>${execution.status_emoji}</span>
              <strong>${execution.status}</strong>
            </div>
            <div class="execution-meta">
              <div style="font-weight: 600;">${formatDateTime(execution.started_at)}</div>
              <div style="font-size: 0.75rem; color: #6c757d; margin-top: 2px;">
                ${formatRelativeTime(new Date(execution.started_at))}
              </div>
              ${gapWarning}
            </div>
            <div class="execution-duration">
              ${execution.duration_formatted}
            </div>
            ${execution.has_error ? '<div style="color: #dc3545; font-size: 0.8rem;">‚ö†Ô∏è Has errors</div>' : ''}
            <div class="execution-actions" style="margin-top: 8px; display: flex; gap: 5px;">
              <button onclick="downloadExecutionReport('${execution._id}')" 
                      class="report-action-btn" 
                      title="Download comprehensive execution report">
                üíæ Report
              </button>
              <button onclick="viewExecutionReport('${execution._id}')" 
                      class="report-action-btn" 
                      title="View execution report details">
                üìã View
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function selectExecution(executionId) {
      // Update UI selection
      document.querySelectorAll('.execution-item').forEach(item => {
        item.classList.remove('selected');
      });
      document.querySelector(`[data-execution-id="${executionId}"]`).classList.add('selected');

      selectedExecution = executionHistory.find(ex => ex._id === executionId);
      
      // Show loading state
      document.getElementById('execution-details-empty').style.display = 'none';
      document.getElementById('execution-details-content').style.display = 'block';
      document.getElementById('execution-details-content').innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <div class="loading-spinner"></div>
          <p style="margin-top: 15px;">Loading execution logs...</p>
        </div>
      `;

      try {
        // Load detailed logs for this execution
        const response = await fetch(`${API_BASE}/frontend/execution-logs/${executionId}`, {
          method: 'GET',
          mode: 'cors',
          credentials: 'include',
          headers: { 
            'Authorization': `Bearer ${getAuthToken()}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const logData = await response.json();
        
        // Store current log data for expand functionality
        window.currentLogData = logData;
        
        renderExecutionDetails(selectedExecution, logData);

        // Show log action buttons when logs are available
        const hasLogs = logData.unified_logs?.logs?.length > 0;
        document.getElementById('download-logs-btn').style.display = hasLogs ? 'inline-block' : 'none';
        document.getElementById('view-full-logs-btn').style.display = hasLogs ? 'inline-block' : 'none';

        // Add event listener for expand logs button (if it exists)
        setTimeout(() => {
          const expandBtn = document.getElementById('expand-logs-btn');
          if (expandBtn) {
            expandBtn.addEventListener('click', expandAllLogs);
          }
        }, 100);

      } catch (error) {
        console.error('Error loading execution logs:', error);
        document.getElementById('execution-details-content').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ùå</div>
            <h3>Error Loading Logs</h3>
            <p>${error.message}</p>
          </div>
        `;
        // Hide log action buttons on error
        document.getElementById('download-logs-btn').style.display = 'none';
        document.getElementById('view-full-logs-btn').style.display = 'none';
      }
    }

    function renderExecutionDetails(execution, logData) {
      const logs = logData.unified_logs?.logs || [];
      const stages = logData.unified_logs?.stages || [];
      const summary = logData.summary || {};

      document.getElementById('execution-details-content').innerHTML = `
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #e9ecef;">
          <h3>Execution Details</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
            <div>
              <strong>Status:</strong><br>
              ${execution.status_emoji} ${execution.status}
            </div>
            <div>
              <strong>Duration:</strong><br>
              ${execution.duration_formatted}
            </div>
            <div>
              <strong>Started:</strong><br>
              ${formatDateTime(execution.started_at)}
            </div>
            <div>
              <strong>Worker:</strong><br>
              ${execution.worker_id}
            </div>
          </div>
          ${execution.error_summary ? `
            <div style="margin-top: 15px; padding: 10px; background: #f8d7da; border-radius: 5px; color: #721c24;">
              <strong>Error:</strong> ${execution.error_summary}
            </div>
          ` : ''}
        </div>

        <div class="log-timeline">
          <h4 style="margin-bottom: 20px;">üìã Execution Timeline</h4>
          ${stages.length > 0 ? renderStageTimeline(stages) : renderLogTimeline(logs)}
        </div>

        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e9ecef;">
          <h4>üìä Log Summary</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-top: 15px;">
            <div class="stat-card">
              <div class="stat-number" style="font-size: 1.5rem;">${summary.total_log_entries || 0}</div>
              <div class="stat-label">Log Entries</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" style="font-size: 1.5rem;">${summary.error_count || 0}</div>
              <div class="stat-label">Errors</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" style="font-size: 1.5rem;">${summary.warning_count || 0}</div>
              <div class="stat-label">Warnings</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" style="font-size: 1.5rem;">${logData.unified_logs?.sources_used?.length || 0}</div>
              <div class="stat-label">Sources</div>
            </div>
          </div>
          <p style="margin-top: 15px; color: #6c757d; font-size: 0.9rem;">
            Sources used: ${logData.unified_logs?.sources_used?.join(', ') || 'None'} | 
            Retrieval status: ${logData.unified_logs?.retrieval_status || 'Unknown'}
          </p>
        </div>
      `;
    }

    function renderStageTimeline(stages) {
      return stages.map(stage => `
        <div class="timeline-item">
          <div class="timeline-marker ${stage.status === 'completed' ? 'success' : 'info'}">
            ${stage.status === 'completed' ? '‚úì' : '‚óè'}
          </div>
          <div class="timeline-content">
            <div class="timeline-title">${stage.name}</div>
            <div class="timeline-time">${formatDateTime(stage.timestamp)}</div>
            <div class="timeline-message">
              Stage ${stage.status} with ${stage.logs?.length || 0} log entries
            </div>
          </div>
        </div>
      `).join('');
    }

    function getLogLevelEmoji(level) {
      const levelMap = {
        'ERROR': '‚ùå',
        'WARNING': '‚ö†Ô∏è',
        'WARN': '‚ö†Ô∏è',
        'INFO': '‚ÑπÔ∏è',
        'DEBUG': 'üêõ',
        'SUCCESS': '‚úÖ'
      };
      return levelMap[level?.toUpperCase()] || '‚ÑπÔ∏è';
    }

    function renderLogTimeline(logs) {
      if (!logs || logs.length === 0) {
        return '<div class="empty-state"><p>No logs available for this execution</p></div>';
      }

      // Show first 10 logs by default
      const displayLogs = logs.slice(0, 10);
      const hasMore = logs.length > 10;

      return displayLogs.map(log => `
        <div class="timeline-item">
          <div class="timeline-marker ${log.level.toLowerCase()}">
            ${log.level_emoji || getLogLevelEmoji(log.level)}
          </div>
          <div class="timeline-content">
            <div class="timeline-title">${log.component}</div>
            <div class="timeline-time">${formatDateTime(log.timestamp)} | ${log.source}</div>
            <div class="timeline-message">${escapeHtml(log.message)}</div>
          </div>
        </div>
      `).join('') + (hasMore ? `
        <div class="timeline-item">
          <div class="timeline-marker info">üìÑ</div>
          <div class="timeline-content">
            <div class="timeline-message">
              <strong>Showing first 10 of ${logs.length} log entries</strong><br>
              <button id="expand-logs-btn" class="primary-button" style="margin-top: 10px;">
                üìÑ View All ${logs.length} Log Entries
              </button>
            </div>
          </div>
        </div>
      ` : '');
    }

    function switchPortfolioTab(tabName) {
      document.querySelectorAll('.portfolio-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.portfolio-content').forEach(content => {
        content.classList.remove('active');
      });

      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      document.getElementById(`${tabName}-portfolio`).classList.add('active');
    }

    async function forceJobExecution() {
      try {
        const response = await fetch(`${API_BASE}/force-execution/${currentAccountId}`, {
          method: 'POST',
          mode: 'cors',
          credentials: 'include',
          headers: { 
            'Authorization': `Bearer ${getAuthToken()}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          showSuccess('Job execution started successfully');
          setTimeout(() => {
            loadJobDetails(true); // Force refresh after action
          }, 2000);
        } else {
          throw new Error(await response.text());
        }
      } catch (error) {
        showError('Failed to start job execution: ' + error.message);
      }
    }

    async function pauseJob() {
      try {
        const isPaused = jobDetails.status === 'PAUSED';
        const endpoint = isPaused ? 'resume' : 'pause';
        
        const response = await fetch(`${API_BASE}/${endpoint}/${currentAccountId}`, {
          method: 'POST',
          mode: 'cors',
          credentials: 'include',
          headers: { 
            'Authorization': `Bearer ${getAuthToken()}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          showSuccess(`Job ${isPaused ? 'resumed' : 'paused'} successfully`);
          loadJobDetails(true); // Force refresh after action
        } else {
          throw new Error(await response.text());
        }
      } catch (error) {
        showError(`Failed to ${jobDetails.status === 'PAUSED' ? 'resume' : 'pause'} job: ` + error.message);
      }
    }

    function viewAllLogs() {
      // Could open a modal or redirect to a comprehensive logs page
      alert('Feature coming soon: Comprehensive logs viewer');
    }

    function downloadCurrentLogs() {
      if (!selectedExecution || !window.currentLogData) {
        showError('No execution or log data selected');
        return;
      }
      
      try {
        const logs = window.currentLogData.unified_logs?.logs || [];
        const summary = window.currentLogData.summary || {};
        
        // Create formatted log content
        let logContent = `=== Job Execution Logs ===\n`;
        logContent += `Execution ID: ${selectedExecution._id}\n`;
        logContent += `Account: ${jobDetails?.account_name || 'Unknown'}\n`;
        logContent += `Status: ${selectedExecution.status}\n`;
        logContent += `Duration: ${selectedExecution.duration_formatted}\n`;
        logContent += `Started: ${formatDateTime(selectedExecution.started_at)}\n`;
        logContent += `Worker: ${selectedExecution.worker_id}\n`;
        logContent += `\n=== Summary ===\n`;
        logContent += `Total Log Entries: ${summary.total_log_entries || 0}\n`;
        logContent += `Errors: ${summary.error_count || 0}\n`;
        logContent += `Warnings: ${summary.warning_count || 0}\n`;
        logContent += `Sources: ${window.currentLogData.unified_logs?.sources_used?.join(', ') || 'None'}\n`;
        logContent += `\n=== Detailed Logs ===\n\n`;
        
        // Add each log entry
        logs.forEach((log, index) => {
          logContent += `[${index + 1}] ${formatDateTime(log.timestamp)} | ${log.level} | ${log.component} | ${log.source}\n`;
          logContent += `    ${log.message}\n`;
          if (log.level_emoji) {
            logContent += `    ${log.level_emoji}\n`;
          }
          logContent += `\n`;
        });
        
        // Create download
        const blob = new Blob([logContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `job-execution-${selectedExecution._id}-logs.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showSuccess('Logs downloaded successfully');
        
      } catch (error) {
        console.error('Error downloading logs:', error);
        showError('Failed to download logs: ' + error.message);
      }
    }

    function viewFullLogs() {
      if (!selectedExecution || !window.currentLogData) {
        showError('No execution or log data selected');
        return;
      }
      
      // Expand all logs inline instead of opening new window
      expandAllLogs();
      
      // Hide the full logs button after expanding
      document.getElementById('view-full-logs-btn').style.display = 'none';
    }

    function expandAllLogs() {
      // Re-render the timeline with all logs
      if (selectedExecution && window.currentLogData) {
        const logs = window.currentLogData.unified_logs?.logs || [];
        const fullTimeline = logs.map(log => `
          <div class="timeline-item">
            <div class="timeline-marker ${log.level.toLowerCase()}">
              ${log.level_emoji || getLogLevelEmoji(log.level)}
            </div>
            <div class="timeline-content">
              <div class="timeline-title">${log.component}</div>
              <div class="timeline-time">${formatDateTime(log.timestamp)} | ${log.source}</div>
              <div class="timeline-message">${escapeHtml(log.message)}</div>
            </div>
          </div>
        `).join('');
        
        // Update the timeline section
        const timelineContainer = document.querySelector('.log-timeline');
        timelineContainer.innerHTML = `
          <h4 style="margin-bottom: 20px;">üìã Complete Execution Timeline (${logs.length} entries)</h4>
          ${fullTimeline}
          <div style="margin-top: 20px; text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <strong>‚úÖ Showing all ${logs.length} log entries</strong>
          </div>
        `;
      }
    }

    function updateLastRefreshTime() {
      document.getElementById('last-refresh').textContent = formatTime(new Date());
    }

    // Utility functions
    function formatDateTime(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatRelativeTime(date) {
      const now = new Date();
      const diff = date.getTime() - now.getTime();
      const absDiff = Math.abs(diff);
      
      if (absDiff < 60000) return diff > 0 ? 'Soon' : 'Just now';
      if (absDiff < 3600000) {
        const mins = Math.floor(absDiff / 60000);
        return diff > 0 ? `In ${mins}m` : `${mins}m ago`;
      }
      if (absDiff < 86400000) {
        const hours = Math.floor(absDiff / 3600000);
        return diff > 0 ? `In ${hours}h` : `${hours}h ago`;
      }
      
      return date.toLocaleDateString();
    }

    function getAuthToken() {
      // Use same token key as admin-dashboard.js
      return localStorage.getItem('token') || sessionStorage.getItem('token') || 
             localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
    }

    function showSuccess(message) {
      console.log('Success:', message);
      // Implement toast notification
    }

    function showError(message) {
      console.error('Error:', message);
      // Implement error notification
    }

    function toggleTheme() {
      if (window.themeManager) {
        window.themeManager.toggleTheme();
      } else {
        console.error('Theme manager not available');
      }
    }

    function logout() {
      localStorage.removeItem('token');
      sessionStorage.removeItem('token');
      localStorage.removeItem('auth_token');
      sessionStorage.removeItem('auth_token');
      window.location.href = 'auth.html';
    }

    function formatTime(date) {
      return date.toLocaleTimeString('en-US', { 
        hour12: false, 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit' 
      });
    }

    // Execution Report Functions
    async function downloadExecutionReport(executionId) {
      try {
        const accountId = getAccountIdFromURL();
        const response = await fetch(`/api/admin/jobs-manager/execution-report/${accountId}/${executionId}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `execution_report_${executionId}.json`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        
      } catch (error) {
        console.error('Error downloading report:', error);
        alert(`Failed to download report: ${error.message}`);
      }
    }

    async function viewExecutionReport(executionId) {
      try {
        const accountId = getAccountIdFromURL();
        const response = await fetch(`/api/admin/jobs-manager/execution-report/${accountId}/${executionId}?format=json`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const reportData = await response.json();
        
        // Display in modal
        document.getElementById('reportModalTitle').textContent = `Execution Report - ${executionId}`;
        document.getElementById('reportModalBody').innerHTML = `
          <pre style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px; max-height: 500px;">${JSON.stringify(reportData, null, 2)}</pre>
        `;
        document.getElementById('reportModal').style.display = 'block';
        
      } catch (error) {
        console.error('Error viewing report:', error);
        alert(`Failed to view report: ${error.message}`);
      }
    }

    function closeReportModal() {
      document.getElementById('reportModal').style.display = 'none';
    }

    // Close modal when clicking outside of it
    window.onclick = function(event) {
      const modal = document.getElementById('reportModal');
      if (event.target === modal) {
        closeReportModal();
      }
    }
  </script>
  <!-- Execution Report Modal -->
  <div id="reportModal" class="report-modal">
    <div class="report-modal-content">
      <div class="report-modal-header">
        <h2 id="reportModalTitle" class="report-modal-title">üìã Comprehensive Execution Report</h2>
        <button class="report-modal-close" onclick="closeReportModal()">&times;</button>
      </div>
      <div id="reportModalBody">
        <!-- Report content will be loaded here -->
      </div>
    </div>
  </div>

</body>
</html>